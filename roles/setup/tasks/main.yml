---
- name: install node curl
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
    

# - name: install node and config paths
#  shell: |
#    export NVM_DIR="$HOME/.nvm"
#    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
#    nvm install node
#    sudo ln -s "$(which node)" "/usr/local/bin/node"
#    sudo ln -s "$(which npm)" "/usr/local/bin/npm"

#    ln -s "$(which node)" "/usr/local/bin/node"
#    ln -s "$(which npm)" "/usr/local/bin/npm"


# Verify node and npm install
# - name: check Node and npm installed version
#  shell: |
#    node --version && npm --version
#  register: command_output
# - debug: var=command_output.stdout_lines
  

- name: "install pm2"
  become: true
  npm:
    name: pm2
    global: yes
    production: yes
    state: present


- name: "configure pm2 path"
  become: yes
  shell: | 
    npm install pm2 -g
    export PATH=$PATH:$(npm config get prefix)/bin


- name: check pm2 installation
  become: yes
  shell: |
    export PATH=$PATH:$(npm config get prefix)/bin
    /root/.nvm/versions/node/v18.7.0/bin/pm2 status
  register: command_output_npm
- debug: var=command_output_npm.stdout_lines
#    sudo ln -s "$(which pm2)" /usr/bin/pm2


- name: Creates directory
  file:
    path: ~/web
    state: directory

- name: Copy index test page
  template:
    src: "files/index.js"
    dest: "~/web/index.js"

- name: Executing node
  become: yes
  shell: |
    /root/.nvm/versions/node/v18.7.0/bin/pm2 start ~/web/index.js -f
  
